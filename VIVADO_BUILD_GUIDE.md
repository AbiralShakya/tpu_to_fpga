# Vivado Build Guide for TPU Bitstream

## Overview

This guide shows how to build the TPU bitstream using **Yosys for synthesis** and **Vivado for place & route**. This avoids the VCC_WIRE/GND_WIRE errors from nextpnr-xilinx.

## Prerequisites

1. **Yosys** - Already installed (used for synthesis)
2. **Vivado** - Must be installed and in PATH
   - Check: `vivado -version`
   - If not found, load module: `module load vivado/2023.1` (on cluster systems)

## Quick Start

```bash
cd /Users/abiralshakya/Documents/tpu_to_fpga
./scripts/build_tpu_bitstream_vivado.sh
```

This will:
1. Run Yosys synthesis → Generate EDIF
2. Run Vivado P&R → Generate bitstream
3. Output: `build/tpu_top_wrapper.bit`

## Step-by-Step Process

### Step 1: Yosys Synthesis (Generate EDIF)

```bash
cd /Users/abiralshakya/Documents/tpu_to_fpga
yosys synthesis/yosys/synth_basys3_vivado.ys
```

**Output**: `build/tpu_basys3.edif`

**What it does**:
- Synthesizes all RTL files
- Optimizes for Xilinx 7-series
- Exports as EDIF (Electronic Design Interchange Format)
- EDIF is a standard format that Vivado can import

### Step 2: Vivado Place & Route

#### Option A: Automated Script (Recommended)

```bash
cd /Users/abiralshakya/Documents/tpu_to_fpga
vivado -mode batch -source vivado/build_tpu_vivado.tcl
```

#### Option B: Manual GUI Steps

1. **Open Vivado**:
   ```bash
   vivado &
   ```

2. **Create Project**:
   - File → New Project
   - Project Name: `tpu_basys3`
   - Project Type: **RTL Project**
   - Part: `xc7a35tcpg236-1` (Basys3)

3. **Import EDIF**:
   - In Sources window, right-click **Design Sources**
   - Add Sources → Add or create design sources
   - Add Files → Select `build/tpu_basys3.edif`
   - Set Top Module: `tpu_top_wrapper`

4. **Add Constraints**:
   - In Sources window, right-click **Constraints**
   - Add Sources → Add or create constraints
   - Add Files → Select `constraints/basys3_nextpnr.xdc`

5. **Run Implementation**:
   - Flow Navigator → **PROGRAM AND DEBUG**
   - Click **Generate Bitstream**
   - Wait 10-30 minutes

6. **Find Bitstream**:
   - Location: `tpu_basys3.runs/impl_1/tpu_top_wrapper.bit`

### Step 3: Program FPGA

```bash
openFPGALoader -b basys3 build/tpu_top_wrapper.bit
```

## File Structure

```
tpu_to_fpga/
├── synthesis/yosys/
│   └── synth_basys3_vivado.ys    # Yosys script (generates EDIF)
├── vivado/
│   └── build_tpu_vivado.tcl       # Vivado P&R script
├── constraints/
│   └── basys3_nextpnr.xdc        # Constraints (works with Vivado)
├── scripts/
│   └── build_tpu_bitstream_vivado.sh  # Complete build script
└── build/
    ├── tpu_basys3.edif            # Generated by Yosys
    └── tpu_top_wrapper.bit        # Final bitstream (generated by Vivado)
```

## What Gets Uploaded/Used

### Files Needed for Vivado:

1. **EDIF Netlist** (`build/tpu_basys3.edif`)
   - Generated by Yosys
   - Contains synthesized gate-level netlist
   - **This is what you upload/use in Vivado**

2. **Constraints File** (`constraints/basys3_nextpnr.xdc`)
   - Pin locations
   - IOSTANDARD settings
   - Clock constraints (if any)

### Files NOT Needed:

- ❌ Original RTL files (already synthesized in EDIF)
- ❌ Yosys scripts (already run)
- ❌ JSON files (only for nextpnr)

## Troubleshooting

### Error: "Vivado not found"

```bash
# Check if Vivado is installed
which vivado

# If on cluster, load module
module load vivado/2023.1

# Or set PATH manually
export PATH=/path/to/vivado/bin:$PATH
```

### Error: "EDIF file not found"

```bash
# Make sure Yosys synthesis ran first
ls -lh build/tpu_basys3.edif

# If missing, run:
yosys synthesis/yosys/synth_basys3_vivado.ys
```

### Error: "Constraints file not found"

The script looks for constraints in this order:
1. `constraints/basys3_nextpnr.xdc`
2. `constraints/basys3.xdc`
3. `simple_test.xdc`

Make sure one of these exists.

### Error: "Top module not found"

- Check that EDIF was generated correctly
- Verify top module name: `tpu_top_wrapper`
- Check Yosys log for errors

### Build Takes Too Long

Vivado P&R typically takes:
- **opt_design**: 1-2 minutes
- **place_design**: 5-15 minutes
- **route_design**: 5-15 minutes
- **write_bitstream**: 1-2 minutes

**Total**: 15-35 minutes for a design this size

## Advantages of Vivado P&R

✅ **No VCC_WIRE/GND_WIRE errors** - Vivado handles constants properly
✅ **Better timing closure** - More sophisticated algorithms
✅ **Full XDC support** - All constraints work (clocks, delays, etc.)
✅ **Reliable** - Industry-standard tool
✅ **Better utilization** - More efficient packing

## Comparison: nextpnr vs Vivado

| Feature | nextpnr-xilinx | Vivado |
|---------|----------------|--------|
| **License** | ✅ Open source | ⚠️ Requires license |
| **VCC_WIRE** | ❌ Fails | ✅ Works |
| **XDC Support** | ⚠️ Limited | ✅ Full |
| **Speed** | ⚠️ Slower | ✅ Faster |
| **Reliability** | ⚠️ Experimental | ✅ Production-ready |

## Next Steps After Build

1. **Test on Hardware**:
   ```bash
   openFPGALoader -b basys3 build/tpu_top_wrapper.bit
   ```

2. **Test UART Communication**:
   ```bash
   python3 python/drivers/tpu_driver.py /dev/tty.usbserial-*
   ```

3. **Run Test Suite**:
   ```bash
   python3 python/test_all_instructions.py /dev/tty.usbserial-*
   ```

## Summary

**To build with Vivado**:
```bash
./scripts/build_tpu_bitstream_vivado.sh
```

**What it does**:
1. Yosys → EDIF (synthesis)
2. Vivado → Bitstream (P&R)

**Output**: `build/tpu_top_wrapper.bit`

**To program**: `openFPGALoader -b basys3 build/tpu_top_wrapper.bit`

